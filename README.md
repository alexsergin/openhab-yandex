# openHAB Yandex Smart Home Connector

Мост из Яндекс УД в openHAB на Node.js

Работает: Вкл, Выкл, Яркость, Цвет.
Пока не поддерживается управление температурой и медиа техникой.

Для работы навыка необходимо иметь рабочую учетную запись на https://myopenhab.org. А для этого надо иметь установленный умный дом openHAB.

## Настройка openHAB:

1. Добавить тег `[ "Room" ]` группам с комнатами, они автоматически добавятся в Яндекс.
2. Добавить теги `[ "Lighting" ]` или `[ "Switchable" ]` к устройствам, которые будут управляться Яндекс.

### Есть официальный опубликованный навык openHAB cloud KnopkaDom.ru

## Подключение навыка:

1. Открываете приложение Яндекс на смартфоне.
2. В зависимости от системы: Android - Нажать Квадратики. iOS - Нажать Три полоски или бургер.
3. Устройства - Умный дом - Плюсик - Добавить Устройство - openHAB cloud KnopkaDom.ru - Объединить аккаунты.
4. Ввести пользователя и пароль от учетной записи myopenhab.org. ВНИМАНИЕ! Это не является абсолютно безопасным. Делайте это на свой страх и риск.
5. Нажать кнопку Разрешить.
6. Обновить список устройств.

## Установка

### Через Docker

Для простоты установки вы можете запустить проект в Docker.

Наш Docker репозиторий доступен на Docker Hub: https://hub.docker.com/r/alexsergin/openhab-yandex

Дальнейшая инструкция предполагает что сам Docker уже установлен у вас в системе. Если это не так, то необходимо скачать его с [официального сайта](https://www.docker.com/products/docker-desktop) установить его под вашу ОС.

Далее можно запустить проект двумя способами:
- Полное окружение (включая mongodb)
- Только контейнер с сервером (если mongodb у вас установлена отодельно)

#### Предварительная настройка

Вам нужен будет SSL сертификат и приватный ключ к нему.

#### Запуск полного окружения

Данный сопособ запускает контейнер с сервером и mongodb и поднимает полностью рабочее окружение.

Перейдите в папку с проектом и создайте там папку `keys`.
И положите в нее сертификат и приватный ключ к нему. Файлы нужно назвать `cert.crt` и `private.pem` соответственно.

В консоли в директории с проектом запустите команду:

```bash
docker-compose -p openhab-yandex up -d
```

#### Запуск только контейнера с сервером

Данный способ предполагает что у вас уже установлена mongodb на текущем или удаленном сервере.

Запустите контейнер с серверм следующей командой:

```bash
docker run -d --name openhab-yandex \
    -v PATH_TO_SSL_CERT:/mnt/data/root/cert.crt \
    -v PATH_TO_SSL_KEY:/mnt/data/root/private.pem \
    -e MONGO_HOST=YOUR_MONGO_HOST
    -p 443:443
    alexsergin/openhab-yandex:latest
```

Не забудьте заменить `PATH_TO_SSL_CERT` и `PATH_TO_SSL_KEY` на пути к SSL сертификату и его ключу.
А также `YOUR_MONGO_HOST` на адрес сервера где у вас установлена mongodb.

### Вручную

Настраиваем репозиторий Node JS

```bash
curl -sL https://deb.nodesource.com/setup_10.x | bash -
```

Устанавливаем необходимые компоненты

```bash
apt-get install -y nodejs git make g++ gcc build-essential
```

Копируем файлы

```bash
git clone https://github.com/alexsergin/openhab-yandex.git /opt/openhab-yandex
```

Задаём права.

```bash
chown -R root:root /opt/openhab-yandex
```

Заходим в директорию и запускаем установку

```bash
cd /opt/openhab-yandex
npm install
````

Запускаем мост (Перед запуском мост нужно настроить)

```bash
npm start
```

#### Автозапуск

В папке /etc/systemd/system/ создайте файл openhabyandex.service и впишите в него:

```
[Unit]
Description=yandex2mqtt
After=network.target

[Service]
ExecStart=/usr/bin/npm start
WorkingDirectory=/opt/openhab-yandex
StandardOutput=inherit
StandardError=inherit
Restart=always
User=root

[Install]
WantedBy=multi-user.target
```

Для включения сервиса впишите в консоль:

```bash
systemctl enable openhabyandex.service
```

После этого можно управлять командами:

```bash
service openhabyandex start

service openhabyandex stop

service openhabyandex restart
```

## Настройка

Для работы моста необходим валидный ssl сертификат. Если нет своего домена и белого IP адреса можно воспользоваться Dynamic DNS сервисами. (на пример noip.com). Для получения сертификата можно воспользоваться приложением certbot.
Все основные настройки моста прописываются в файл `config.js`. Перед запуском обязательно отредактируйте настройки.

## Создание своего навыка

Заходим на https://dialogs.yandex.ru/developer/skills => Создать диалог => Умный дом

Название: Любое
Endpoint URL: https://вашдомен/provider
Ставим галку "Не показывать в каталоге"
Имя разработчика: Ваше имя
Нажимаем "Добавить новую" связку
Название: Любое
Идентификатор и секрет : можно добавить в базе данных MongoDB см. модель.

URL авторизации: https://вашдомен/dialog/authorize
URL для получения токена: https://вашдомен/oauth/token

Сохраняем связку и выбираем её в навыке. Выбираем иконку, пишем описание, нажимаем "Сохранить".
Дальше жмём "На модерацию" и сразу "Опубликовать". Готово.
Навык появится в приложении Яндекс в разделе "Устройства" => умный дом.
Свяжите аккаунты и обновите список устройств. После этого устройства будут доступны для управления через Алису.